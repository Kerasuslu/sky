<!DOCTYPE html>
<html lang="en" dir="ltr">
<head prefix="og: http://ogp.me/ns#">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-145066191-2"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-145066191-2');</script>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>sky_instruments</title>
	<meta name="Description" content="Sky's instruments simulator. PWA(offline) compatible.">
	<link rel="shortcut icon" type="image/svg+xml" href="img/ico/instr.svg">
	<meta property="og:type" content="website">
	<meta property="og:title" content="sky_instruments">
	<meta property="og:description" content="Skyの楽器練習ができるページです">
	<meta property="og:url" content="https://mcbeeringi.github.io/sky/instr.html">
	<meta property="og:image" content="https://mcbeeringi.github.io/sky/img/ico/instr.jpg">
	<!--iOS-->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="sky stuff">
	<link rel="apple-touch-icon" href="img/sky.png">
	<!--sw-->
	<link rel="manifest" href="skymf.json">
	<meta name="theme-color" content="#214"/>
	<script>
		if('serviceWorker'in navigator&&location.protocol.includes('http')&&location.hostname!='localhost')window.addEventListener('load',()=>{navigator.serviceWorker.register('skysw.js').then((reg)=>{console.log('skysw Registered',reg);});});
	</script>
	<link rel="preload" href="https://cdn.jsdelivr.net/npm/tone/build/Tone.js" as="script">
</head>
<body>
	<script src="style.js" async></script>
	<style>
		:root{user-select:none;-webkit-user-select:none;touch-action:manipulation;--key_size:min(88px,20vw);--bp:0 0;}
		html,body{width:100%;height:100%;position:relative;margin:0;overflow:hidden;text-align:center;}*::-webkit-scrollbar{display:none;}
		input[type=radio]{display:none;}
		@keyframes flip{0%{transform:rotateY(0deg);}100%{transform:rotateY(360deg);}}
		@keyframes bob{0%{transform:scale(1);}100%{transform:scale(.97);}}
		body>input{display:none;}

		#kb{display:inline-grid;grid-template-columns:repeat(5,var(--key_size));grid-auto-rows:0;grid-template-rows:repeat(3,var(--key_size));margin:calc(var(--key_size) * .5) 0 0 0;vertical-align:bottom;touch-action:none;}
		#kb p{position:relative;margin:0;}
		#kb p::before{content:"";display:block;width:78.4%;height:78.4%;margin:10.8%;border-radius:17%;background:0 0/800% #3338 url(img/instr.svg);}
		#kb:not(.oct) p:nth-of-type(5n+1)::before{background-position:-100% 0;}#kb:not(.oct) p:nth-of-type(5n+2)::before{background-position:-200% 0;}
		#kb:not(.oct) p:nth-of-type(5n+3)::before{background-position:-100% 0;}#kb:not(.oct) p:nth-of-type(5n+4)::before{background-position:-200% 0;}
		#kb:not(.oct) p:nth-of-type(5n  )::before{background-position:-100% 0;}#kb:not(.oct) p:nth-of-type(7n+1)::before{background-position:0 0;}
		#kb.oct{grid-template-columns:repeat(4,var(--key_size));grid-template-rows:repeat(2,var(--key_size));}
		#kb.oct p:nth-of-type(4n+1)::before{background-position:-200% 0;}#kb.oct p:nth-of-type(4n+2)::before{background-position:-100% 0;}
		#kb.oct p:nth-of-type(4n+3)::before{background-position:-200% 0;}#kb.oct p:nth-of-type(4n  )::before{background-position:-100% 0;}
		#kb p.anm::before{animation:flip .4s ease-in-out;}

		.grid{display:inline-block;width:70px;height:70px;margin:7px;border-radius:16px;position:relative;cursor:pointer;background:var(--bp)/800% #3338 url(img/instr.svg);}
		.grid::before{content:"";display:block;height:100%;box-sizing:border-box;border:16px solid #0000;border-image:url(img/sel.svg) 33.333%;-webkit-border-image:url(img/sel.svg) 33.333%;opacity:0;transition:.2s;}
		.grid.tex{background-image:url(img/tex.webp);}
		*:checked+.grid::before{opacity:1;}*:checked+.grid{transform:rotateY(360deg);transition:.5s;}*:disabled+.grid{filter:grayscale(1)opacity(.7);}

		body>[for=drwcb]{display:none;pointer-events:none;}
		#drawer{width:252px;height:100%;padding-top:50.4px;position:absolute;top:0;right:0;overflow-y:scroll;background-color:#3338;transform:translateX(100%);transition:.2s;backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);}
		#menu>label{display:inline-block;}#menu>label>.grid{display:block;animation:bob .6s ease-in-out 0s infinite alternate;}
		.btnw{position:absolute;top:0;right:0;transform-origin:top right;transform:scale(.6);}
		.btnw>*{transition:transform .4s linear;}.btnw>[for=kbsize]{--bp:-500% 0;}.btnw>[for=drwcb]{--bp:0 -100%;}
		@media(max-width:700px){
			body>[for=drwcb]{display:block;width:100%;height:100%;position:absolute;top:0;left:0;}
			.btnw{top:unset;bottom:0;transform-origin:bottom right;}#drawer{padding-top:unset;padding-bottom:50.4px;}
		}

		#kbsize:checked~.btnw>[for=kbsize]{transform:rotateY(360deg);--bp:-600% 0;}#kbsize:checked~*{--key_size:min(110px,20vw);}
		#drwcb:checked~.btnw>[for=drwcb]{transform:rotateY(360deg);background-image:url(img/instr.svg);--bp:-400% 0 !important;}#drwcb:checked~#drawer{transform:translateX(0);}#drwcb:checked~[for=drwcb]{pointer-events:auto;}
	</style>
	<input type="checkbox" id="drwcb">
	<input type="checkbox" id="kbsize">
	<div id="kb">Please enable JavaScript to use this app.</div>
	<label for="drwcb"></label>
	<div id="drawer">
		<form id="menu">
							<label><input type="radio" name="instr" value="0"  checked ><div class="grid tex" style="--bp:-0%   -100%;"></div>
			</label><label><input type="radio" name="instr" value="1"          ><div class="grid tex" style="--bp:-100% -100%;"></div>
			</label><label><input type="radio" name="instr" value="2"          ><div class="grid tex" style="--bp:-200% -100%;"></div>
			</label><label><input type="radio" name="instr" value="3"          ><div class="grid tex" style="--bp:-300% -100%;"></div>
			</label><label><input type="radio" name="instr" value="4"          ><div class="grid tex" style="--bp:-400% -100%;"></div>
			</label><label><input type="radio" name="instr" value="5"          ><div class="grid tex" style="--bp:-500% -100%;"></div>
			</label><label><input type="radio" name="instr" value="6"          ><div class="grid tex" style="--bp:-600% -100%;"></div>
			</label><label><input type="radio" name="instr" value="7"  disabled><div class="grid tex" style="--bp:-700% -100%;"></div>
			</label><label><input type="radio" name="instr" value="8"          ><div class="grid tex" style="--bp:-0%   -200%;"></div>
			</label><label><input type="radio" name="instr" value="9"          ><div class="grid tex" style="--bp:-100% -200%;"></div>
			</label><label><input type="radio" name="instr" value="10"         ><div class="grid tex" style="--bp:-200% -200%;"></div>
			</label><label><input type="radio" name="instr" value="11"         ><div class="grid tex" style="--bp:-300% -200%;"></div>
			</label><label><input type="radio" name="instr" value="12"         ><div class="grid tex" style="--bp:-400% -200%;"></div>
			</label><label><input type="radio" name="instr" value="13"         ><div class="grid tex" style="--bp:-500% -200%;"></div>
			</label><label><input type="radio" name="instr" value="14"         ><div class="grid tex" style="--bp:-600% -200%;"></div>
			</label><label><input type="radio" name="instr" value="15"         ><div class="grid tex" style="--bp:-700% -200%;"></div>
			</label><label><input type="radio" name="instr" value="16"         ><div class="grid tex" style="--bp:-0%   -300%;"></div>
			</label><label><input type="radio" name="instr" value="17"         ><div class="grid tex" style="--bp:-100% -300%;"></div>
			</label>
		</form>
	</div>
	<div class="btnw">
		<label for="kbsize" class="grid"></label>
		<label for="drwcb" id="mico" class="grid tex"></label>
	</div>
	<pre id="log">build: 2108170 beta</pre>

	<script src="https://cdn.jsdelivr.net/npm/tone/build/Tone.js"></script>
	<script>
		'use strict';
		const reverb=new Tone.Reverb({wet:0,decay:.001}).toDestination(),
		stdli=(a,b=a+1,s={})=>{for(let i=a;i<=b;i++){s['d#'+i]=`ds${i}.mp3`;s['a'+i]=`a${i}.mp3`;}return s;},
		instr_li=[//[baseurl, octave, map, (map2)]
			['audio/instr/musicbox/',1,stdli(4,6,{a3:'a3.mp3','d#7':'ds7.mp3'})],
			['audio/instr/harp/',-1,stdli(3,5)],//210503
			['audio/instr/percussion/',-1,{a3:'0.mp3','a#3':'1.mp3',b3:'2.mp3',c4:'3.mp3',a4:'4.mp3','a#4':'5.mp3',b4:'6.mp3',c5:'7.mp3'}],
			['audio/instr/contrabass/',-2,stdli(2)],
			['audio/instr/horn/',-1,stdli(3)],
				['audio/instr/piano/',0,stdli(4)],
				['',0,{'d#5':'audio/instr/musicbox/ds6.mp3',a5:'audio/instr/musicbox/a6.mp3'},{'d#5':'audio/instr/glock/ds5.mp3',a5:'audio/instr/glock/a5.mp3'}],
				['audio/instr/bell2/',1,{c4:'c4.mp3',d4:'d4.mp3',g4:'g4.mp3',a4:'a4.mp3'},{c4:'c4_.mp3',d4:'d4_.mp3',g4:'g4_.mp3',a4:'a4_.mp3'}],
			['audio/instr/flute/',0,stdli(4,6)],//210419
			['audio/instr/quena/',0,stdli(4,6)],//210419
			['audio/instr/guitar/',-1,stdli(3,5)],//210503
			['audio/instr/ukulele/',-1,stdli(3,5)],//210419
				['audio/instr/piano/',1,stdli(5)],
			['audio/instr/glock/',0,stdli(4,6)],//210529
			['audio/instr/handpan/',-1,stdli(3)],
			['audio/instr/dundun/',-1,{a3:'0.mp3','a#3':'1.mp3',b3:'2.mp3',c4:'3.mp3',a4:'4.mp3','a#4':'5.mp3',b4:'6.mp3',c5:'7.mp3'}],
			['audio/instr/pipa/',-1,stdli(3,5)],//210529
			['audio/instr/bugle/',0,stdli(4,6)]//210529
		],
		kbmode=(x=menu.instr.value)=>[0,0,1,0,0,0,2,2,0,0,0,0,0,0,3,1,0,0][Number(x)||0],
		_keymap=[
			Array.from('QWERTASDFGZXCVB',x=>`Key${x}`),
			Array.from('QWERASDF',x=>`Key${x}`)
		],
		keymap=(x=kbmode())=>_keymap[[0,1,1,1][x]],
		i2n=(i,x=kbmode())=>[
			[-9,-7,-5,-4,-2,0,2,3,5,7,8,10,12,14,15],
			[0,1,2,3,12,13,14,15],
			[-9,-7,-2,0,-9,-7,-2,0],
			[-7,0,3,5,8,10,12,15]
		][x][i],
		setSynth=(fx=()=>{kb.style.opacity='1'; kb.style.pointerEvents='auto';})=>{
			synth=new Tone.Sampler(instr_li[menu.instr.value][2],fx,instr_li[menu.instr.value][0]).connect(reverb);
		},
		set=()=>{
			kb.style.opacity='.2';kb.style.pointerEvents='none';
			switch([0,1,2,1][kbmode()]){
				case 1:
					kb.classList.add('oct');
					setSynth();
					synth_=synth;
					break;
				case 2:
					kb.classList.add('oct');
					Promise.all([
						new Promise(t=>
							setSynth(t)
						),
						new Promise(t=>
							synth_=new Tone.Sampler(instr_li[menu.instr.value][3],t,instr_li[menu.instr.value][0]).connect(reverb)
						)
					]).then(()=>{
						kb.style.opacity='1'; kb.style.pointerEvents='auto';
					});
					break;
				default:
					kb.classList.remove('oct');
					setSynth();
					synth_=synth;
			}
			//save();
			mico.setAttribute('style',`--bp:${[menu.instr.value%8,Math.floor(menu.instr.value*.125+1)].map(x=>(x*-100)+'%').join(' ')};`);
		},
		trigger=i=>{
			const x=kbmode();
			(i>3?synth_:synth).triggerAttackRelease(440*Math.pow(2,i2n(i,x)/12+instr_li[menu.instr.value][1]));
		};
		let synth,synth_;

		kb.textContent='';
		for(let i=0;i<15;i++){
			const x=document.createElement('p');
			['touchstart','mousedown'].forEach(y=>x.addEventListener(y,e=>{
				trigger(i);
				x.classList.remove('anm');void x.offsetWidth;x.classList.add('anm');
			},{passive:true}));
			['touchend','touchcancel'].forEach(y=>x.addEventListener(y,e=>{
				e.preventDefault();
			},{passive:false}));
			x.addEventListener('animationend',()=>{
				x.classList.remove('anm');
			},{passive:true});
			kb.appendChild(x);
		}
		document.onkeydown=e=>{
			if(keymap().includes(e.code))
				kb.children[keymap().indexOf(e.code)].dispatchEvent(new Event('mousedown'));
		};
		menu.onchange=()=>{
			set();
		};

		menu.onchange();
		if(['Chrome','Safari'].findIndex(x=>window.navigator.userAgent.includes(x))==1)
			{
				let img=new Image();
				img.onload=()=>{
					let c=document.createElement('canvas'),ctx=c.getContext('2d');
					c.width=img.naturalWidth;c.height=img.naturalHeight;
					ctx.drawImage(img,0,0);
					document.body.insertAdjacentHTML('beforeend',`<style>#kb p::before{background-image:url(${c.toDataURL()});}</style>`);
				};
				img.src='img/instr.svg';
			}
	</script>
</body>
</html>
