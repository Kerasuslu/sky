<!DOCTYPE html>
<html lang="en">
	<head prefix="og: http://ogp.me/ns#">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-145066191-2"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-145066191-2');</script>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>sky_instruments</title>
		<meta name="Description" content="Sky's instrments simulator. PWA(offline) compatible.">
		<link rel="shortcut icon" type="image/jpeg" href="img/ico/instr.jpg">
		<meta property="og:type" content="website">
		<meta property="og:title" content="sky_instruments">
		<meta property="og:description" content="Skyの楽器練習ができるページです">
		<meta property="og:url" content="https://mcbeeringi.github.io/sky/instr.html">
		<meta property="og:image" content="https://mcbeeringi.github.io/sky/img/ico/instr.jpg">
		<!--iOS-->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="default">
		<meta name="apple-mobile-web-app-title" content="sky instr">
		<link rel="apple-touch-icon" href="img/sky.png">
		<!--sw-->
		<link rel="manifest" href="skymf.json">
		<meta name="theme-color" content="#fea"/>
		<script>
			if('serviceWorker'in navigator&&location.protocol.includes('http'))window.addEventListener('load',()=>{navigator.serviceWorker.register('skysw.js').then((reg)=>{console.log('skysw Registered',reg);});});
		</script>
	</head>
	<body>
		<script src="style.js" async></script>
		<script src="https://cdn.jsdelivr.net/npm/tone/build/Tone.js"></script>
		<script>let ifwebp=new Image();ifwebp.onerror=()=>document.body.classList.add('nowebp');ifwebp.src='img/tex.webp';</script>
		<style>
			:root{user-select:none;-webkit-user-select:none;touch-action:manipulation;overflow:hidden;color:#fff;}
			html,body{width:100%;height:100%;position:relative;margin:0;overflow:hidden;}*::-webkit-scrollbar{display:none;}
			.bg_,.fg_{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}.fg_{z-index:10;}.fg_>*{pointer-events:auto;}
			.bg_>video{width:100%;height:100%;object-fit:cover;transition:2s;}.bg_>div{width:100%;height:64px;position:absolute;top:0;left:0;background:linear-gradient(#0008,#0000);}
			hr{border:none;}hr::before{content:"";display:block;margin:0 auto;width:4px;height:4px;background:#8888;border-radius:50%;}
			input[type=range]{outline:none;appearance:none;-webkit-appearance:none;height:24px;width:100%;
				background:linear-gradient(45deg, #0000 6px,#0008 6px),linear-gradient(135deg,#0000 6px,#0008 6px),linear-gradient(225deg,#0000 6px,#0008 6px),linear-gradient(315deg,#0000 6px,#0008 6px);
				background-position:bottom left,top left,top right,bottom right;background-size:50% 50%;background-repeat:no-repeat;
			}
			input[type=range]::-webkit-slider-thumb{appearance:none;-webkit-appearance:none;height:16.8px;width:16.8px;background:#aef;box-shadow:0 0 8px #aef,0 0 4px #0008 inset;transform:rotateZ(45deg);border-radius:0;}/*input[type=range]::-moz-range-thumb*/
			.revW{position:relative;}.revW::before{content:"";position:absolute;width:48px;height:48px;top:50%;left:50%;transform:translate(-50%,-50%);background:url(img/tex.webp);background-size:800%;background-position:-700% -0%;opacity:.7;pointer-events:none;}
			.nowebp .revW::before{background:url(img/tex.png);}
			#alcb{display:none;}
			#alcb+label{display:block;width:100%;height:100%;background:#0008;opacity:0;backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);pointer-events:none;transition:.2s;}
			#alcb:checked+label{opacity:1;pointer-events:auto;}
			#albox{width:calc(90% - 40px);max-width:256px;min-height:128px;border-radius:16px;padding:20px;margin:0;box-sizing:border-box;white-space:pre-wrap;background:#4448;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}


			@keyframes bob{0%{transform:scale(.95);}100%{transform:scale(.9);}}
			@keyframes flip{0%{transform:rotateY(0deg);}100%{transform:rotateY(360deg);}}
			.kb{position:relative;left:50%;transform:translateX(-50%);touch-action:none;display:inline-block;pointer-events:none;opacity:.2;transition:.2s;white-space:nowrap;}
			.kb>div>div{position:relative;width:20vmin;height:20vmin;max-width:84px;max-height:84px;margin:0;display:inline-block;vertical-align:top;}
			.kb>div>div>div{position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;width:83.33%;height:83.33%;background:#2228;border-radius:23%;z-index:0;box-shadow:0 0 8px #2228;}
			.kb>div>div>div::before{content:"";display:block;width:100%;height:100%;animation:bob .6s ease-in-out 0s infinite alternate;background:url(img/tex.webp);background-size:800% auto;z-index:1;}
			.nowebp .kb>div>div>div::before{background:url(img/tex.png);}
			.kb>div>div:nth-child(2n  ):not(.c)>div::before{background-position:-100% 0;}
			.kb>div>div:nth-child(2n-1):not(.c)>div::before{background-position:-200% 0;}

			.kb>div>div.pushed>div{transform:scale(.8);}.kb>div>div:not(.pushed)>div{transition:.1s;}
			.kb>div>div.anm>div::before{animation:flip .4s ease-in-out;}


			#menucb{display:none;}
			#menucb+label{position:absolute;top:0;right:0;width:100%;height:100%;display:none;pointer-events:none;}#menucb:checked+label{display:block;}
			#menucb+*+*+label{position:absolute;top:2px;right:2px;width:48px;height:48px;transition:.2s;touch-action:none;}
			#menucb:checked+*+*+label{transform:rotateY(180deg);}
			#menucb+*+*+label::before,#mico{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:url(img/tex.webp);background-size:800%;transition:.4s;}
			.nowebp #menucb+*+*+label::before,.nowebp #mico{background:url(img/tex.png);}
			#menucb+*+*+label::before{opacity:0;background-position:-400% 0;}#mico{background-position:0 -100%;}
			#menucb:checked+*+*+label::before{opacity:1;}#menucb:checked+*+*+label>#mico{opacity:0;}
			.menu{position:fixed;top:0;right:-266px;width:252px;height:calc(100% - 48px);padding:48px 7px 0;background:#4448;opacity:0;box-shadow:0 0 8px #4448;transition:.2s;overflow-y:scroll;}
			#menucb:checked+*+div{right:0;opacity:1;}
			@media(max-width:512px){#menucb+*+*+label{top:unset;bottom:2px;}#menucb+label{pointer-events:unset;}.menu{padding:0 7px 48px;}}

			.menu input[type=radio]{display:none;}.menu label,.menu .grid{display:inline-block;vertical-align:top;position:relative;}
			.menu input[type=radio]+div,.menu .grid{width:70px;height:70px;margin:7px;background:#2228;border-radius:16px;box-shadow:0 0 8px #2228;}
			.menu input[type=radio]+div::before,.menu .grid::before{position:absolute;content:"";display:block;width:70px;height:70px;background:url(img/tex.webp);background-size:560px auto;background-position:var(--bp);}
			.nowepb .menu input[type=radio]+div::before,.nowebbp .menu .grid::before{background:url(img/tex.png);}
			.menu input[type=radio]:disabled+div{opacity:.5;}
			.menu input[type=radio]:checked+div,.menu .grid.recording{box-shadow:0 0 0 2px #fea inset,0 0 8px #fea4;}
			.menu input[type=radio]:checked+div::before{animation:flip .4s ease-in-out;}
			.menu .grid{touch-action:none;}.menu .grid.button:active::before{transform:scale(.8);}.menu .grid.button:not(:active)::before{transition:.2s;}

			#scd,#scd_{transition:.2s}
			#scd_{position:absolute;top:0;left:0;width:100%;height:100%;filter:drop-shadow(0 0 2px #aef);background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 6l1 1l-1 1l-1 -1l1 -1%0A' fill='%23caf0f6'/%3E%3C/svg%3E");}
		</style>
		<div class="bg_">
			<!--<video muted autoplay loop playsinline src="img/hotsprv.mp4" type="video/mp4" id="bgv"></video>-->
			<div></div>
		</div>
		<div class="fg_">
			<pre id="jswarn">Please enable JavaScript to use this app.</pre><script>jswarn.style.display='none';</script>
			<input type="checkbox" id="alcb"><label for="alcb"><pre id="albox" class="style"></pre></label>
		</div>
		<div id="kb" class="kb">
			<div><div id="_-9" class="c"></div><div id="_-7"></div><div id="_-5"></div><div id="_-4"></div><div id="_-2"></div></div>
			<div><div id="_0"></div><div id="_2"></div><div id="_3"  class="c"></div><div id="_5" ></div><div id="_7" ></div></div>
			<div><div id="_8" ></div><div id="_10" ></div><div id="_12"  ></div><div id="_14"  ></div><div id="_15"   class="c"></div></div>
		</div>
		<div id="pkb" class="kb" style="display:none;">
			<div><div id="0_0"></div><div id="0_1"></div><div id="0_2"></div><div id="0_3"></div></div>
			<div><div id="1_0"></div><div id="1_1"></div><div id="1_2"></div><div id="1_3"></div></div>
		</div>
		<input type="checkbox" id="menucb" onchange="sfx.player(this.checked?'op':'cl').start();"><label for="menucb"></label>
		<div class="menu">
			<form id="menu" onchange="set();sfx.player('cs').start();">
				        <label><input type="radio" name="instr" value="0"  checked ><div style="--bp:-0%   -200%;"></div>
				</label><label><input type="radio" name="instr" value="1"          ><div style="--bp:-100% -200%;"></div>
				</label><label><input type="radio" name="instr" value="2"          ><div style="--bp:-200% -200%;"></div>
				</label><label><input type="radio" name="instr" value="3"          ><div style="--bp:-300% -200%;"></div>
				</label><label><input type="radio" name="instr" value="4"          ><div style="--bp:-400% -200%;"></div>
				</label><label><input type="radio" name="instr" value="5"          ><div style="--bp:-500% -200%;"></div>
				</label><label><input type="radio" name="instr" value="6"          ><div style="--bp:-600% -200%;"></div>
				</label><label><input type="radio" name="instr" value="7"  disabled><div style="--bp:-700% -200%;"></div>
				</label><label><input type="radio" name="instr" value="8"          ><div style="--bp:-0%   -300%;"></div>
				</label><label><input type="radio" name="instr" value="9"          ><div style="--bp:-100% -300%;"></div>
				</label><label><input type="radio" name="instr" value="10"         ><div style="--bp:-200% -300%;"></div>
				</label><label><input type="radio" name="instr" value="11"         ><div style="--bp:-300% -300%;"></div>
				</label><label><input type="radio" name="instr" value="12"         ><div style="--bp:-400% -300%;"></div>
				</label><label><input type="radio" name="instr" value="13"         ><div style="--bp:-500% -300%;"></div>
				</label><label><input type="radio" name="instr" value="14"         ><div style="--bp:-600% -300%;"></div>
				</label><label><input type="radio" name="instr" value="15"         ><div style="--bp:-700% -300%;"></div>
				</label><label><input type="radio" name="instr" value="16"         ><div style="--bp:-0%   -400%;"></div>
				</label>
			</form>
			<hr>
			<div id="scd">
				      <div ontouchstart="" class="grid button" style="--bp:-600% -0%;" onclick="sc--;scale(1);">
				</div><div class="grid" style="--bp:-200% -0%;filter:saturate(.3)" onclick="sc=0;scale(1);"><div id="scd_"></div>
				</div><div ontouchstart="" class="grid button" style="--bp:-500% -0%;" onclick="sc++;scale(1);"></div>
			</div>
			<hr>
			<div class="revW">
				<input type="range" id="slrvw" value="0" min="0" max="1" step="0.01" onchange="reverb.wet.value=this.value;save();">
				<input type="range" id="slrvd" value="0" min="0" max="6" step="0.06" onchange="reverb.decay=Math.pow(2,this.value);save();">
			</div>
			<hr>
			<div id="envbtn" class="grid button" style="--bp:-0% -100%;">
			</div><div id="recbtn" class="grid button" style="--bp:-100% -100%;">
			</div><div class="grid button" style="--bp:-300% -0%;" onclick="alert(info);"></div>
		</div>
		<label for="menucb"><div id="mico"></div></label>


		<script>
			'use strict';
			let synth,synth_,kbmode=0,sc=0,env=[[],{l:3,c:0}],recorder;
			alert=x=>{albox.textContent=x;alcb.checked=true;};
			const reverb=new Tone.Reverb({wet:0,decay:0}).toDestination(),
			sfx=new Tone.Players({urls:{op:'open.mp3',cl:'close.mp3',cs:'choose.mp3'},baseUrl:'https://mcbeeringi.github.io/sky/audio/'}).toDestination(),
			stdli=(a,b=a+1,s={})=>{
				for(let i=a;i<=b;i++){
					s['d#'+i]=`ds${i}.mp3`;
					s['a' +i]=`a${i}.mp3`;
				}
				return s;
			},
			info='Powerd by Tone.js\nAudio: GarageBand, Tone.js Salamander(cc-by Alexander Holm), record and denoise by @McbeEringi\n\nauthor:@McbeEringi\nbuild:2103241\nMIT License',
			instr_li=[//[baseurl, octave, map, (map2)]
				['musicbox/',1,stdli(4,6,{a3:'a3.mp3','d#7':'ds7.mp3'})],
				['harp/',-1,stdli(3)],
				['percussion/',-1,{a3:'0.mp3','a#3':'1.mp3',b3:'2.mp3',c4:'3.mp3',a4:'4.mp3','a#4':'5.mp3',b4:'6.mp3',c5:'7.mp3'}],
				['contrabass/',-2,stdli(2)],
				['horn/',-1,stdli(3)],
					['piano/',0,stdli(4)],
					['',1,{'d#5':'musicbox/ds5.mp3',a5:'musicbox/a5.mp3'},{'d#5':'glock/ds5.mp3',a5:'glock/a5.mp3'}],
					['bell2/',1,{c4:'c4.mp3',d4:'d4.mp3',g4:'g4.mp3',a4:'a4.mp3'},{c4:'c4_.mp3',d4:'d4_.mp3',g4:'g4_.mp3',a4:'a4_.mp3'}],
					['flute/',0,stdli(4)],
				['quena/',0,stdli(4)],
				['guitar/',-1,stdli(3)],
				['ukulele/',-1,stdli(3)],
					['piano/',1,stdli(5)],
					['glock/',1,stdli(5)],
				['handpan/',-1,stdli(3)],
				['dundun/',-1,{a3:'0.mp3','a#3':'1.mp3',b3:'2.mp3',c4:'3.mp3',a4:'4.mp3','a#4':'5.mp3',b4:'6.mp3',c5:'7.mp3'}],
					['pipa/',-1,stdli(3)]
			],
			pmap={
				2:[[0,1,2,3],[12,13,14,15]],
				6:[[-9,-7,-2,0],[-9,-7,-2,0]],
				7:[[-9,-7,-2,0],[-9,-7,-2,0]],
				14:[[-7,0,3,5],[8,10,12,15]],
				15:[[0,1,2,3],[12,13,14,15]]
			},
			keymap=[{
				KeyR:'_-9',KeyT:'_-7',KeyY:'_-5',KeyU:'_-4',KeyI:'_-2',
				KeyF:'_0' ,KeyG:'_2' ,KeyH:'_3' ,KeyJ:'_5' ,KeyK:'_7' ,
				KeyC:'_8' ,KeyV:'_10',KeyB:'_12',KeyN:'_14',KeyM:'_15'
			},{
				KeyR:'0_0',KeyT:'0_1',KeyY:'0_2',KeyU:'0_3',
				KeyF:'1_0',KeyG:'1_1',KeyH:'1_2',KeyJ:'1_3'
			}],
			save=()=>{localStorage.instr_sc=sc;localStorage.instr_instr=menu.instr.value;localStorage.instr_reverb=`${slrvw.value},${slrvd.value}`;localStorage.instr_env=env[1].c;console.log('saved');},
			load=()=>{
				let c=[localStorage.instr_sc,localStorage.instr_instr,localStorage.instr_reverb,localStorage.instr_env];
				if(c){
					if(c[0])sc=parseInt(c[0]);
					if(c[1])try{menu.instr[parseInt(c[1])].checked=true;}catch(e){console.log(e);}
					if(c[2])try{[slrvw.value,slrvd.value]=c[2].split(',');[reverb.wet.value,reverb.decay]=[slrvw.value,Math.pow(2,slrvd.value)];}catch(e){console.log(e);}
					if(c[3])try{env[1].c=Number(c[3]);}catch(e){console.log(e);}
					console.log('loaded');
				}
			},
			setSynth=()=>{
				synth=new Tone.Sampler(instr_li[menu.instr.value][2],()=>{
					 kb.style.opacity='1'; kb.style.pointerEvents='auto';
					pkb.style.opacity='1';pkb.style.pointerEvents='auto';
				},'https://mcbeeringi.github.io/sky/audio/instr/'+instr_li[menu.instr.value][0]).connect(reverb);
			},
			set=()=>{
				kb.style.opacity='.2';kb.style.pointerEvents='none';pkb.style.opacity='.2';pkb.style.pointerEvents='none';
				//keyboard switch
				kbmode=1;
				kb.style.display='none';pkb.style.display='';
				scd.style.opacity='1';scd.style.pointerEvents='auto';
				scale();setSynth();
				switch(menu.instr.value){
					case '2':case '15':
						scd.style.opacity='.2';scd.style.pointerEvents='none';scd_.style.transform='none';
						synth_=synth;
						break;
					case '6':case '7':
						synth_=new Tone.Sampler(instr_li[menu.instr.value][3],()=>{},'https://mcbeeringi.github.io/sky/audio/instr/'+instr_li[menu.instr.value][0]).connect(reverb);
						break;
					case '14':synth_=synth;break;
					default:kbmode=0;synth_=null;pkb.style.display='none';kb.style.display='';
				}
				save();
				//icon
				let pos=[menu.instr.value%8,Math.floor(menu.instr.value*.125+2)];console.log('ico',pos);
				mico.style.backgroundPosition=pos.map(x=>(x*-100)+'%').join(' ');
			},
			trigger=id=>{
				switch(kbmode){
					case 0://C4~C6
						synth.triggerAttackRelease(440*Math.pow(2,(parseInt(id.slice(1))+(scd.style.opacity=='1'?sc:0))/12+instr_li[menu.instr.value][1]));
						break;
					case 1:
						if(id.substr(0,1)=='0')synth.triggerAttackRelease(440*Math.pow(2,(pmap[menu.instr.value][0][id.substr(-1)]+(scd.style.opacity=='1'?sc:0))/12+instr_li[menu.instr.value][1]));
						else synth_.triggerAttackRelease(440*Math.pow(2,(pmap[menu.instr.value][1][id.substr(-1)]+(scd.style.opacity=='1'?sc:0))/12+instr_li[menu.instr.value][1]));
						break;
					default:
						console.log('unknown id');
				}
			},
			scale=x=>{
				scd_.style.transform=`rotate(${sc*30}deg)`;
				if(x){
					save();
					synth.triggerAttackRelease(440*Math.pow(2,(3+sc)/12+instr_li[menu.instr.value][1]),'1m','+.05');
					if(kbmode==0){
						synth.triggerAttackRelease(440*Math.pow(2,(7 +sc)/12+instr_li[menu.instr.value][1]),'1m','+.1');
						synth.triggerAttackRelease(440*Math.pow(2,(10+sc)/12+instr_li[menu.instr.value][1]),'1m','+.15');
					}
				}
			},
			envset=()=>{
				env[0].forEach(y=>{if(y)y.stop();});
				if(env[1].c<=env[1].l){
					if(env[0][env[1].c])env[0][env[1].c].start();
					else{
						env[0][env[1].c]=new Tone.Player({url:`https://mcbeeringi.github.io/sky/audio/env${env[1].c}.mp3`,volume:-8,autostart:true,loop:true,fadeIn:5,fadeOut:2}).toDestination();
						if(recorder)env[0][env[1].c].connect(recorder);
					}
				}
			};

			try{recorder=new Tone.Recorder();reverb.connect(recorder);}catch(e){console.log(e);recbtn.style.filter='grayscale(1)opacity(.5)';recbtn.style.pointerEvents='none';}
			load();set();scale();envset();
			document.querySelectorAll('.kb>div>div').forEach(key=>{
				key.appendChild(document.createElement('div'));
				//sound & anm
				const down=e=>{
					e.preventDefault();trigger(key.id);
					key.classList.remove('pushed');void key.offsetWidth;key.classList.add('pushed','anm');
				},up=e=>{e.preventDefault();key.classList.remove('pushed');};
				['touchstart','mousedown'].forEach(x=>key.addEventListener(x,down,{passive:false}));
				['touchend','touchcancel','mouseup','mouseleave'].forEach(x=>key.addEventListener(x,up,{passive:false}));
				key.addEventListener('animationend',()=>{key.classList.remove('anm');});
			})
			document.addEventListener('keydown',e=>{if(keymap[kbmode][e.code]&&kb.style.opacity=='1')window[keymap[kbmode][e.code]].dispatchEvent(new Event('touchstart'));});
			document.addEventListener('keyup',e=>{if(keymap[kbmode][e.code]&&kb.style.opacity=='1')window[keymap[kbmode][e.code]].dispatchEvent(new Event('touchend'));});
			envbtn.onclick=()=>{
				if(env[1].l<env[1].c)env[1].c=0;else env[1].c++;
				alert('ambient sound\n\n\t>>'+['hotspring','home','forest','vault','🔇'][env[1].c]);
				envset();save();
			};
			recbtn.onclick=e=>{
				if(e.target.classList.toggle('recording'))recorder.start();
				else(async()=>{
					let recording=await recorder.stop(),e=document.createElement('a');
					e.download=`sky_instr ${new Date().toLocaleString()}.${/\/mp/.test(recorder.mimeType)?'m4a':'webm'}`;e.href=URL.createObjectURL(recording);
					e.click();llog('rcstop');setTimeout(URL.revokeObjectURL,3000,e.href);
				})();
			};

			const fsc=()=>{
				let doc=window.document,docEl=doc.documentElement;
				let init=docEl.requestFullscreen||docEl.mozRequestFullScreen||docEl.webkitRequestFullScreen||docEl.msRequestFullscreen;
				let exit=doc.exitFullscreen||doc.mozCancelFullScreen||doc.webkitExitFullscreen||doc.msExitFullscreen;
				if(doc.fullscreenElement||doc.mozFullScreenElement||doc.webkitFullscreenElement||doc.msFullscreenElement)exit.call(doc);
				else init.call(docEl);
			};
			/*document.addEventListener('visibilitychange',()=>{
				if(document.visibilityState=='visible'){bgv.play();console.log('become visible');location.reload(false);}
				if(document.visibilityState=='hidden')console.log('become hidden');
			});*/
		</script>
	</body>
</html>
