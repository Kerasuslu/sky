<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<title>SkyEringi sky_sequencer</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
</head>
<body>
	<script src="style.js"></script>
	<script src="https://tonejs.github.io/build/Tone.js"></script>
	<style>
		.grid,button{display:inline-block;width:64px;height:64px;margin:4px;background:#6668;color:#fff;text-shadow:0 0 4px #0008;border:none;border-radius:16px;box-shadow:0 0 8px #6668;text-align:center;vertical-align:middle;}
		button,input{outline:none;font-size:24px;font-family:"M PLUS Rounded 1c",sans-serif;padding:0;}
		.bg{background-image:url(img/seq.png);background-size:800% auto;background-position:var(--bp);}
	</style>


	<button onclick="Tone.start();ptoggle()">⏯
	</button><button onclick="pstop()">⏹
	</button><input id="bpm_" class="grid bg" type="num" onchange="bpmpr(this);" style="--bp:0px -64px;"></input><br>
	<button onclick="sc--;sc_.textContent=sc;">-</button><button id="sc_" class="grid" onclick="sc=main.sc;sc_.textContent=sc;"></button><button onclick="sc++;sc_.textContent=sc;">+</button><br>
	<pre id="log"></pre>

	<script>
		var seq,sc=Number(sc_.value),main;
		const llog=(x,c)=>{if(c)log.textContent='';log.textContent+=`\n${x}`;}
		const url_o=(x)=>JSON.stringify(x).replace(/\"/g,"'").replace(/,/g,'.').replace(/\[/g,'(').replace(/\]/g,')'), url_i=(x)=>JSON.parse(x.replace(/'/g,'"').replace(/\./g,',').replace(/\(/g,'[').replace(/\)/g,']'));
		const mbxli = ()=>{var s={};for(var i=3;i<=6;i++){s[`a${i}`]=`a${i}.mp3`;s[`d#${i+1}`]=`ds${i+1}.mp3`;}return s;};
		const synth = new Tone.Sampler(mbxli(),()=>{},"https://mcbeeringi.github.io/sky/audio/instr/musicbox/").connect(new Tone.Volume(-10).toDestination());
		const sample = {
			"bpm":90,
			"sc":10,
			"scores":[
				'-4,0,3,7,10',['7,10','-4,0,3'],'7,10','-4,0,3,7,10',
				'-5,2,5,7,10',['5,7,14','-5,2'],'5,7,14','-5,2,12,15',

				'0,3',['7,10','0,3'],'7,10',['0,3,7,10','5,8'],
				['-9,-2','3,7'],['','-2'],['','-2'],['3,7','-2'],

				'-4,0',['3','-4,0'],['3,7','-4,0'],['3','2,5,7'],
				['-5','2,5'],['','-5'],['','-5'],['2,5,7','-5'],

				'-5,0',['3','3,0'],['','-5,0'],['3','-5,0'],
				'-9,-2',['-9','-9,-5'],['','-5,-2'],['-2,3','3,7']
			]
		};

		main=sample;

		/////from button
		function ptoggle(){
			if(Tone.Transport.state=='started')Tone.Transport.pause();
			else Tone.Transport.start();
		}
		function pstop(){
			Tone.Transport.stop();
		}
		function bpmpr(this_){
			var tmp = Number(this_.value);
			if(tmp){main.bpm=tmp;Tone.Transport.bpm.value=tmp;}
			bpm_.value=Tone.Transport.bpm.value;
			llog(bpm_.value);
		}

		/////Sequence
		const toHz = (x)=>440*Math.pow(2,(Number(x)+sc)/12);
		function set(x){
			if(seq)seq.dispose();
			seq = new Tone.Sequence((time,note)=>{
				if(note){
					note=note.split(',');
					//synth.triggerAttackRelease(note,'1m',time);
					synth.triggerAttackRelease(note.map(toHz),'1m',time);
					llog(`${note.map(x=>49+Number(x))}\n\t${Tone.Transport.position}`,1);
				}
			},x).start(0);
			return seq;
		}
		set(main.scores);
		sc=main.sc;
		sc_.textContent=sc;
		Tone.Transport.bpm.value=main.bpm;
		bpm_.value=Tone.Transport.bpm.value;
		Tone.Transport.timeSignature = [4, 4];

		/////keyboard
		document.addEventListener('keydown',e=>{
			llog(e.code);
			switch (e.code) {
				case 'Space':
					ptoggle();
					break;
				default:

			}
		},false);

	</script>
</body>
</html>
