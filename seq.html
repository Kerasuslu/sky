<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<title>sky_sequencer</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
</head>
<body>
	<script src="style.js"></script>
	<script src="https://tonejs.github.io/build/Tone.js"></script>
	<style>
		body{margin:0;}*::-webkit-scrollbar{display:none;}
		.grid{display:inline-block;width:64px;height:64px;margin:4px;background:#4448;color:#caf0f6;text-shadow:0 0 4px #688;border:none;border-radius:16px;box-shadow:0 0 8px #4448;text-align:center;vertical-align:middle;outline:none;font-size:24px;font-family:"M PLUS Rounded 1c",sans-serif;padding:0;touch-action:manipulation;}
		.bg{background-image:url(img/seq.png);background-size:800% auto;background-position:var(--bp);}

		#disp{position:relative;width:100vw;height:240px;background-image:url(img/15.png);background-size:auto 100%;image-rendering:pixelated;background-size:100% 100%;}
		#disp>*,#disp0,#disp1{position:absolute;line-height:16px;font-size:14px;}#disp0,#disp1{border-left:24px solid #0008;display:flex;}
		#disp>div:first-child{width:100%;height:100%;overflow:scroll;}

		.nWrapper{display:block;position:relative;width:16px;height:240px;border-left:1px solid;}
		.nWrapper:nth-child(4n+1){border-color:#f88;}.nWrapper:last-child{width:0;}
	</style>

	<div id="disp">
		<div>
			<div id="disp0">disp0</div>
			<div id="disp1">disp1</div>
		</div>
		<div style="opacity:.5;pointer-events:none;">
			C<br>B<br>A<br>G<br>F<br>E<br>D<br>
			C<br>B<br>A<br>G<br>F<br>E<br>D<br>C
		</div>
	</div>
	<div>
		<button onclick="Tone.start();ptoggle()" class="grid bg" style="--bp:0px -64px;"></button><button onclick="pstop()"class="grid bg" style="--bp:-64px -64px;"></button><br>

		<button onclick="main.bpm-=6;Tone.Transport.bpm.value-=6;bpm_.value=main.bpm;" class="grid bg" style="--bp:-384px 0px;">
		</button><input id="bpm_" class="grid bg" onchange="bpmset();" style="--bp:-448px 0px;">
		</input><button onclick="main.bpm+=6;Tone.Transport.bpm.value+=6;bpm_.value=main.bpm;" class="grid bg" style="--bp:-320px 0px;"></button><br>

		<button onclick="main.sc--;sc_.value=main.sc;" class="grid bg" style="--bp:-384px 0px;">
		</button><input id="sc_" class="grid bg" onchange="scset();" style="--bp:-128px -64px;">
		</input><button onclick="main.sc++;sc_.value=main.sc;" class="grid bg" style="--bp:-320px 0px;"></button><br>
	</div>

	<pre id="log"></pre>

	<script>
		var seq0,seq1,sc=Number(sc_.value),main;
		const ver=[0,1,0],
		llog=(x,c)=>{if(c)log.textContent='';log.textContent+=`\n${x}`;},
		scset=()=>{if(Number(sc_.value))main.sc=Number(sc_.value);else sc_.value=main.sc;llog(main.sc);},
		bpmset=()=>{var tmp=Number(bpm_.value);if(tmp){main.bpm=tmp;Tone.Transport.bpm.value=tmp;}else bpm_.value=main.bpm;llog(main.bpm);},
		url_o=(x)=>JSON.stringify(x).replace(/\"/g,"'").replace(/,/g,'.').replace(/\[/g,'(').replace(/\]/g,')'), url_i=(x)=>JSON.parse(x.replace(/'/g,'"').replace(/\./g,',').replace(/\(/g,'[').replace(/\)/g,']')),
		mbxli = ()=>{var s={};for(var i=3;i<=6;i++){s[`a${i}`]=`a${i}.mp3`;s[`d#${i+1}`]=`ds${i+1}.mp3`;}return s;},
		synth = new Tone.Sampler(mbxli(),()=>{},"https://mcbeeringi.github.io/sky/audio/instr/musicbox/").connect(new Tone.Volume(-10).toDestination()),
		sample = {
			"bpm":90,
			"sc":-2,
			"scores0":[
				'7,10','7,10','7,10','7,10',
				'7,10','7,14','7,14','12,15',

				'','7,10','7,10',['7,10','5,8'],
				['','3,7'],'','','3,7',

				'','3','3,7',['3','2,5,7'],
				['','2,5'],'','','2,5,7',

				'',['3','3,0'],'','3',
				'','','',''
			],
			"scores1":[
				'-4,0,3',['','-4,0,3'],'','-4,0,3',
				'-5,2,5',['5','-5,2'],'5','-5,2',

				'0,3',['','0,3'],'','0,3',
				'-9,-2',['','-2'],['','-2'],['','-2'],

				'-4,0',['','-4,0'],['','-4,0'],'',
				['-5',''],['','-5'],['','-5'],['','-5'],

				'-5,0','',['','-5,0'],['','-5,0'],
				'-9,-2',['-9','-9,-5'],['','-5,-2'],['-2,3','3,7']
			]
		};

		main=sample;
		log.textContent=ver;

		/////from button
		function ptoggle(){
			if(Tone.Transport.state=='started')Tone.Transport.pause();
			else Tone.Transport.start();
		}
		function pstop(){
			Tone.Transport.stop();
		}

		/////Sequence
		const toHz = (x)=>880*Math.pow(2,(Number(x)+main.sc)/12);//C5~C7
		function set(x,i){
			if([seq0,seq1][i])[seq0,seq1][i].dispose();
			[seq0,seq1][i] = new Tone.Sequence((time,note)=>{
				if(note){
					note=note.split(',');
					synth.triggerAttackRelease(note.map(toHz),'1m',time);
					llog(`${note.map(x=>49+Number(x))}\n\t${Tone.Transport.position}`,1);
				}
			},x).start(0);
		}
		set(main.scores0,0);
		set(main.scores1,1);

		function render(scores,e){
			scores.map(x=>{
				var div = document.createElement('div');
				if(x){
					//console.log(x.split(','));
				}
				div.classList.add('nWrapper');
				e.insertBefore(div,e.lastChild);
			})
			var div=document.createElement('div');
			div.classList.add('nWrapper');
			e.insertBefore(div,e.lastChild);
		}
		render(main.scores0,disp0);

		sc_.value=main.sc;
		bpm_.value=main.bpm;
		Tone.Transport.bpm.value=main.bpm;
		Tone.Transport.timeSignature=[4,4];

		/////keyboard
		document.addEventListener('keydown',e=>{
			llog(e.code);
			switch (e.code) {
				case 'Space':
					ptoggle();
					break;
				default:

			}
		},false);

	</script>
</body>
</html>
