<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<body>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.43/Tone.js"></script>
		<script src="style.js"></script>
		<style>
			:root{user-select:none;-webkit-user-select:none;}
			body{position:relative;overflow:hidden;margin:0;}
			#bg::before{width:100%;height:64px;content:"";position:absolute;background:linear-gradient(#0008,#0000);}
		</style>

		<style>
			@keyframes bob{0%{transform:scale(1);}100%{transform:scale(.9);}}
			@keyframes p{0%{transform:rotateY(0deg);}100%{transform:rotateY(360deg);}}
			.kb{position:relative;left:50%;transform:translateX(-50%);touch-action:none;display:inline-block;pointer-events:none;opacity:.2;}
			.kb>div>div{position:relative;width:84px;height:84px;margin:0;flex-shrink:0;display:inline-block;vertical-align:top;}
			.kb>div>div::before,.kb>div>div::after{content:"";display:block;position:absolute;top:7px;left:7px;width:70px;height:70px;}
			.kb>div>div::before{background:#6668;border-radius:16px;z-index:0;box-shadow:0 0 8px #6668;}
			.kb>div>div::after{animation:bob 1.2s ease-in-out 0s infinite alternate;background-image:url(img/tex.png);background-size:560px auto;z-index:1;}
			.kb>div>div:nth-child(2n  ):not(.c)::after{background-position:-70px 0;}
			.kb>div>div:nth-child(2n-1):not(.c)::after{background-position:-140px 0;}

			.kb>div>div.pushed::before,.kb>div>div.pushed::after{transform:scale(.8);}
			.kb>div>div:not(.pushed)::before,.kb>div>div:not(.pushed)::after{transition:.1s;}
			.kb>div>div.anm::after{animation:p .4s ease-in-out;}
		</style>
		<div id="kb" class="kb">
			<div><div id="_-21" class="c"></div><div id="_-19"></div><div id="_-17"></div><div id="_-16"></div><div id="_-14"></div></div>
			<div><div id="_-12"></div><div id="_-10"></div><div id="_-9"  class="c"></div><div id="_-7" ></div><div id="_-5" ></div></div>
			<div><div id="_-4" ></div><div id="_-2" ></div><div id="_0"  ></div><div id="_2"  ></div><div id="_3"   class="c"></div></div>
		</div>
		<div id="pkb" class="kb" style="display:none;">
			<div><div id="0_0"></div><div id="0_1"></div><div id="0_2"></div><div id="0_3"></div></div>
			<div><div id="1_0"></div><div id="1_1"></div><div id="1_2"></div><div id="1_3"></div></div>
		</div>

		<style>
			#menucb{display:none;}
			#menucb+label{position:fixed;top:0;right:0;width:100vw;height:100vh;display:none;}
			#menucb:checked+label{display:block;}
			#menucb+*+*+label{position:fixed;top:2px;right:2px;width:48px;height:48px;transition:.2s}
			#menucb:checked+*+*+label{transform:rotateY(180deg);}
			#menucb+*+*+label::before,#mico{content:"";position:absolute;top:0;left:0;width:48px;height:48px;background:url(img/tex.png);background-size:384px auto;transition:.4s;}
			#menucb+*+*+label::before{opacity:0;background-position:-192px 0;}#mico{background-position:0 -48px;}
			#menucb:checked+*+*+label::before{opacity:1;}#menucb:checked+*+*+label>#mico{opacity:0;}
			.menu{position:fixed;top:0;right:-266px;width:252px;height:100vh;padding:48px 7px 0;background:#8888;opacity:0;box-shadow:0 0 8px #8888;transition:.2s;overflow-y:scroll;}
			#menucb:checked+*+div{right:0;opacity:1;}

			.menu input[type=radio]{display:none;}.menu label{display:inline-block;vertical-align:top;}
			.menu input[type=radio]+div{width:70px;height:70px;margin:7px;background:#4448;border-radius:16px;box-shadow:0 0 8px #6668;}
			.menu input[type=radio]+div::before{content:"";display:block;width:70px;height:70px;background:url(img/tex.png);background-size:560px auto;background-position:var(--bp);}
			.menu input[type=radio]:disabled+div{opacity:.5;}
			.menu input[type=radio]:checked+div{box-shadow:0 0 0 2px #fea inset,0 0 8px #fea4;}
			.menu input[type=radio]:checked+div::before{transform:rotateY(360deg);transition:.5s;}
		</style>
		<input type="checkbox" id="menucb" onchange="if(this.checked){sfx('click');sfx('open');}else sfx('close');"><label for="menucb"></label>
		<div class="menu">
			見た目だけです <br>
			<form id="menu" onchange="set();">
				        <label><input type="radio" name="instr" value="0"  checked ><div style="--bp:-0px   -70px ;"></div>
				</label><label><input type="radio" name="instr" value="1"          ><div style="--bp:-70px  -70px ;"></div>
				</label><label><input type="radio" name="instr" value="2"          ><div style="--bp:-140px -70px ;"></div>
				</label><label><input type="radio" name="instr" value="3"          ><div style="--bp:-210px -70px ;"></div>
				</label><label><input type="radio" name="instr" value="4"          ><div style="--bp:-280px -70px ;"></div>
				</label><label><input type="radio" name="instr" value="5"          ><div style="--bp:-350px -70px ;"></div>
				</label><label><input type="radio" name="instr" value="6"          ><div style="--bp:-420px -70px ;"></div>
				</label><label><input type="radio" name="instr" value="7"          ><div style="--bp:-490px -70px ;"></div>
				</label><label><input type="radio" name="instr" value="8"          ><div style="--bp:-0px   -140px;"></div>
				</label><label><input type="radio" name="instr" value="9"          ><div style="--bp:-70px  -140px;"></div>
				</label><label><input type="radio" name="instr" value="10"         ><div style="--bp:-140px -140px;"></div>
				</label><label><input type="radio" name="instr" value="11"         ><div style="--bp:-210px -140px;"></div>
				</label><label><input type="radio" name="instr" value="12"         ><div style="--bp:-280px -140px;"></div>
				</label><label><input type="radio" name="instr" value="13"         ><div style="--bp:-350px -140px;"></div>
				</label><label><input type="radio" name="instr" value="14" disabled><div style="--bp:-420px -140px;"></div>
				</label>
			</form>
		</div>
		<label for="menucb"><div id="mico"></div></label>

		<br>
		<button onclick="fsc()">fullscreen</button>


		<script>
			const sfx_vol=new Tone.Volume(-10).toDestination(), sfx_={
				"open" :new Tone.Player("audio/open.mp3").connect(sfx_vol),
				"close":new Tone.Player("audio/close.mp3").connect(sfx_vol),
				"click":new Tone.Player("audio/click.mp3").connect(sfx_vol)
			};
			const sfx = (i)=>sfx_[i].start();
			var kbmode=0,sc=12;
			const keymap = [{
				"KeyR":"_-21","KeyT":"_-19","KeyY":"_-17","KeyU":"_-16","KeyI":"_-14",
				"KeyF":"_-12","KeyG":"_-10","KeyH":"_-9" ,"KeyJ":"_-7" ,"KeyK":"_-5" ,
				"KeyC":"_-4" ,"KeyV":"_-2" ,"KeyB":"_0"  ,"KeyN":"_2"  ,"KeyM":"_3"
			},{
				"KeyR":"0_0","KeyT":"0_1","KeyY":"0_2","KeyU":"0_3",
				"KeyF":"1_0","KeyG":"1_1","KeyH":"1_2","KeyJ":"1_3"
			}];
			const synth = new Tone.Sampler({
					"a2":"a2.mp3",
					"d#3":"ds3.mp3","a3":"a3.mp3",
					"d#4":"ds4.mp3","a4":"a4.mp3",
					"d#5":"ds5.mp3","a5":"a5.mp3",
					"d#6":"ds6.mp3"
				},()=>{
					 kb.style.opacity="1"; kb.style.pointerEvents="auto";
					pkb.style.opacity="1";pkb.style.pointerEvents="auto";
				},"audio/instr/musicbox/").toDestination();
			function set() {
				sfx("click");
				var pos = [menu.instr.value%8,Math.floor(menu.instr.value*.125+1)];
				console.log("ico",pos);
				mico.style.backgroundPosition=pos.map(x=>(x*-48)+"px").join(" ");
			}
			function trigger(id) {
				switch(kbmode){
					case 0:
						synth.triggerAttackRelease(440*Math.pow(2,(parseInt(id.slice(1))+sc)/12));
						break;
					case 1:
						synth.triggerAttackRelease("C5","8n");
						break;
					default:
						console.log("unknown id");
				}
			}


			//animation & misc
			document.querySelectorAll('.kb>div>div').forEach((e)=>{
				e.addEventListener("touchstart",function(){trigger(this.id);},false);
				e.addEventListener("mousedown" ,function(){trigger(this.id);},false);
				e.addEventListener("touchstart",function(){
					this.classList.remove('pushed');void this.offsetWidth;this.classList.add('pushed','anm');
				},false);
				e.addEventListener("mousedown",function(){
					this.classList.remove('pushed');void this.offsetWidth;this.classList.add('pushed','anm');
					setTimeout(()=>this.classList.remove('pushed'),100);
				},false);
				e.addEventListener("touchend",function(e){this.classList.remove('pushed');e.preventDefault();},false);
				e.addEventListener("touchcancel",function(){this.classList.remove('pushed');e.preventDefault();},false);
				e.addEventListener("animationend",function(){this.classList.remove('anm');},false);
			})
			document.addEventListener('keydown',e=>{
				if(keymap[kbmode][e.code])document.getElementById(keymap[kbmode][e.code]).dispatchEvent(new Event('mousedown'));
			},false);

			//fullscreen
			function fsc(){
				var doc=window.document,docEl=doc.documentElement;
				var init=docEl.requestFullscreen||docEl.mozRequestFullScreen||docEl.webkitRequestFullScreen||docEl.msRequestFullscreen;
				var exit=doc.exitFullscreen||doc.mozCancelFullScreen||doc.webkitExitFullscreen||doc.msExitFullscreen;

				if(doc.fullscreenElement||doc.mozFullScreenElement||doc.webkitFullscreenElement||doc.msFullscreenElement)exit.call(doc);
				else init.call(docEl);
			}
		</script>
	</body>
</html>
